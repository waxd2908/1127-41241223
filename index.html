<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase CRUD 筆記系統</title>
    <!-- 引入 Bootstrap 5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <h1 class="text-center">會員系統與筆記管理</h1>
        <div class="text-center my-4">
            <button id="registerBtn" class="btn btn-primary">註冊</button>
            <button id="loginBtn" class="btn btn-success">登入</button>
            <button id="showUserInfoBtn" class="btn btn-info d-none">會員信息</button>
            <button id="logoutBtn" class="btn btn-danger d-none">登出</button>
        </div>

        <!-- 用戶資料區 -->
        <div class="modal fade" id="userInfoModal" tabindex="-1" aria-labelledby="userInfoModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="userInfoModalLabel">會員信息</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img id="modalUserPhoto" src="" alt="用戶頭像" class="img-fluid rounded-circle mb-3"
                            style="width: 100px;">
                        <h5 id="modalUserName" class="card-title"></h5>
                        <p id="modalUserEmail" class="card-text"></p>
                        <p id="modalLastLogin" class="card-text text-muted"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 筆記管理區 -->
        <div id="crudSection" class="d-none mt-5">
            <h3 class="text-center">筆記管理</h3>
            <form id="noteForm" class="mb-4">
                <div class="mb-3">
                    <label for="noteTitle" class="form-label">標題</label>
                    <input type="text" id="noteTitle" class="form-control" placeholder="輸入筆記標題" required>
                </div>
                <div class="mb-3">
                    <label for="noteContent" class="form-label">內容</label>
                    <textarea id="noteContent" class="form-control" rows="3" placeholder="輸入筆記內容" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">新增筆記</button>
                <button type="button" id="cancelEditBtn" class="btn btn-secondary d-none">取消修改</button>
            </form>

            <!-- 顯示筆記區 -->
            <div id="notesList" class="mt-4">
                <h4>你的筆記</h4>
                <div class="list-group"></div>
            </div>
        </div>
    </div>

    <!-- 引入 Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyDcaCg9G3TRz1dJAb5ixmAAnhmT-1gALHc",
                authDomain: "sample-firebase-ai-app2-1772f.firebaseapp.com",
                databaseURL: "https://sample-firebase-ai-app2-1772f-default-rtdb.firebaseio.com",
                projectId: "sample-firebase-ai-app2-1772f",
                storageBucket: "sample-firebase-ai-app2-1772f.appspot.com",
                messagingSenderId: "824252885125",
                appId: "1:824252885125:web:347ed0836149b7ea3aa1ec"
            };

            firebase.initializeApp(firebaseConfig);

            const auth = firebase.auth();
            const database = firebase.database();
            const provider = new firebase.auth.GoogleAuthProvider();

            let currentUserId = null;
            let editingNoteId = null;

            // 註冊按鈕
            document.getElementById('registerBtn').addEventListener('click', () => {
                auth.signInWithPopup(provider)
                    .then((result) => {
                        saveUserData(result.user);
                        showAlert("success", "註冊成功！");
                    })
                    .catch((error) => {
                        showAlert("error", "註冊失敗", error.message);
                    });
            });

            // 登入按鈕
            document.getElementById('loginBtn').addEventListener('click', () => {
                auth.signInWithPopup(provider)
                    .then((result) => {
                        checkIfUserExists(result.user);
                        showAlert("success", "登入成功！");
                    })
                    .catch((error) => {
                        showAlert("error", "登入失敗", error.message);
                    });
            });

            // 登出按鈕
            document.getElementById('logoutBtn').addEventListener('click', () => {
                auth.signOut()
                    .then(() => {
                        resetUI();
                        showAlert("success", "登出成功！");
                    })
                    .catch((error) => {
                        showAlert("error", "登出失敗", error.message);
                    });
            });

            // 儲存用戶資料
            function saveUserData(user) {
                const userData = {
                    name: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    lastLogin: new Date().toISOString()
                };

                database.ref('users/' + user.uid).set(userData)
                    .then(() => {
                        currentUserId = user.uid;
                        displayUserData(userData);
                        loadNotes();
                    })
                    .catch((error) => {
                        console.error('保存用戶資料失敗：', error);
                    });
            }

            // 檢查用戶是否存在
            function checkIfUserExists(user) {
                database.ref('users/' + user.uid).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const userData = snapshot.val();
                            displayUserData(userData);
                            currentUserId = user.uid;
                            loadNotes();
                        } else {
                            saveUserData(user);
                        }
                    })
                    .catch((error) => {
                        console.error('檢查用戶失敗：', error);
                    });
            }

            // 顯示用戶資料
            function displayUserData(userData) {
                document.getElementById('modalUserPhoto').src = userData.photoURL;
                document.getElementById('modalUserName').textContent = `姓名：${userData.name}`;
                document.getElementById('modalUserEmail').textContent = `Email：${userData.email}`;
                document.getElementById('modalLastLogin').textContent = `最後登入時間：${userData.lastLogin}`;

                document.getElementById('showUserInfoBtn').classList.remove('d-none');
                document.getElementById('logoutBtn').classList.remove('d-none');
                document.getElementById('registerBtn').classList.add('d-none');
                document.getElementById('loginBtn').classList.add('d-none');
                document.getElementById('crudSection').classList.remove('d-none');
            }

            // 重置 UI
            function resetUI() {
                document.getElementById('showUserInfoBtn').classList.add('d-none');
                document.getElementById('logoutBtn').classList.add('d-none');
                document.getElementById('registerBtn').classList.remove('d-none');
                document.getElementById('loginBtn').classList.remove('d-none');
                document.getElementById('crudSection').classList.add('d-none');
            }

            // 顯示提示訊息
            function showAlert(type, title, text = "") {
                Swal.fire({
                    icon: type,
                    title: title,
                    text: text
                });
            }

            // 新增筆記
            document.getElementById('noteForm').addEventListener('submit', (event) => {
                event.preventDefault();

                const title = document.getElementById('noteTitle').value;
                const content = document.getElementById('noteContent').value;

                if (editingNoteId) {
                    updateNote(editingNoteId, title, content);
                } else {
                    createNote(title, content);
                }
            });

            // 新增筆記函數
            function createNote(title, content) {
                const newNoteRef = database.ref('notes').push();
                newNoteRef.set({
                    userId: currentUserId,
                    title: title,
                    content: content,
                    timestamp: new Date().toISOString()
                })
                .then(() => {
                    showAlert("success", "筆記已新增！");
                    loadNotes();
                    resetForm();
                })
                .catch((error) => {
                    console.error('新增筆記失敗：', error);
                });
            }

            // 更新筆記函數
            function updateNote(noteId, title, content) {
                const noteRef = database.ref('notes/' + noteId);
                noteRef.update({
                    title: title,
                    content: content
                })
                .then(() => {
                    showAlert("success", "筆記已更新！");
                    loadNotes();
                    resetForm();
                })
                .catch((error) => {
                    console.error('更新筆記失敗：', error);
                });
            }

            // 取消編輯並重置表單
            document.getElementById('cancelEditBtn').addEventListener('click', () => {
                resetForm();
            });

            // 重置表單
            function resetForm() {
                document.getElementById('noteTitle').value = '';
                document.getElementById('noteContent').value = '';
                document.getElementById('cancelEditBtn').classList.add('d-none');
                editingNoteId = null;
            }

            // 讀取筆記
            function loadNotes() {
                const notesList = document.getElementById('notesList').querySelector('.list-group');
                notesList.innerHTML = '';

                database.ref('notes').orderByChild('userId').equalTo(currentUserId).once('value')
                    .then((snapshot) => {
                        snapshot.forEach((childSnapshot) => {
                            const note = childSnapshot.val();
                            const noteId = childSnapshot.key;

                            const noteItem = document.createElement('div');
                            noteItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
                            noteItem.innerHTML = `
                                <strong>${note.title}</strong>
                                <button class="btn btn-sm btn-warning" onclick="editNote('${noteId}')">修改</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteNote('${noteId}')">刪除</button>
                            `;
                            notesList.appendChild(noteItem);
                        });
                    })
                    .catch((error) => {
                        console.error('讀取筆記失敗：', error);
                    });
            }

            // 編輯筆記
            window.editNote = function(noteId) {
                const noteRef = database.ref('notes/' + noteId);
                noteRef.once('value')
                    .then((snapshot) => {
                        const note = snapshot.val();
                        document.getElementById('noteTitle').value = note.title;
                        document.getElementById('noteContent').value = note.content;
                        document.getElementById('cancelEditBtn').classList.remove('d-none');
                        editingNoteId = noteId;
                    })
                    .catch((error) => {
                        console.error('編輯筆記失敗：', error);
                    });
            };

            // 刪除筆記
            window.deleteNote = function(noteId) {
                const noteRef = database.ref('notes/' + noteId);
                noteRef.remove()
                    .then(() => {
                        showAlert("success", "筆記已刪除！");
                        loadNotes();
                    })
                    .catch((error) => {
                        console.error('刪除筆記失敗：', error);
                    });
            };

        });
    </script>
</body>

</html>
