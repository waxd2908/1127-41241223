<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase 筆記系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <h1 class="text-center">筆記管理系統</h1>
        <div class="mt-4">
            <button id="registerBtn" class="btn btn-primary">註冊</button>
            <button id="loginBtn" class="btn btn-success">登入</button>
            <button id="logoutBtn" class="btn btn-danger d-none">登出</button>
        </div>

        <!-- 筆記管理 -->
        <div id="crudSection" class="d-none mt-5">
            <h3 class="text-center">筆記管理</h3>
            <form id="noteForm">
                <div class="mb-3">
                    <label for="noteTitle" class="form-label">標題</label>
                    <input type="text" id="noteTitle" class="form-control" placeholder="輸入筆記標題" required>
                </div>
                <div class="mb-3">
                    <label for="noteContent" class="form-label">內容</label>
                    <textarea id="noteContent" class="form-control" rows="3" placeholder="輸入筆記內容" required></textarea>
                </div>
                <input type="hidden" id="editingNoteId">
                <button type="submit" class="btn btn-primary">保存筆記</button>
            </form>

            <div id="notesList" class="mt-4">
                <h4>你的筆記</h4>
                <div class="list-group"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "YOUR_API_KEY",
                authDomain: "YOUR_AUTH_DOMAIN",
                databaseURL: "YOUR_DATABASE_URL",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
            };

            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const database = firebase.database();
            const provider = new firebase.auth.GoogleAuthProvider();
            let currentUserId = null;

            // 註冊
            document.getElementById('registerBtn').addEventListener('click', () => {
                auth.signInWithPopup(provider)
                    .then((result) => {
                        saveUserData(result.user);
                        showAlert("success", "註冊成功！");
                    })
                    .catch((error) => {
                        showAlert("error", "註冊失敗", error.message);
                    });
            });

            // 登入
            document.getElementById('loginBtn').addEventListener('click', () => {
                auth.signInWithPopup(provider)
                    .then((result) => {
                        currentUserId = result.user.uid;
                        showAlert("success", "登入成功！");
                        document.getElementById('crudSection').classList.remove('d-none');
                        loadNotes();
                    })
                    .catch((error) => {
                        showAlert("error", "登入失敗", error.message);
                    });
            });

            // 登出
            document.getElementById('logoutBtn').addEventListener('click', () => {
                auth.signOut()
                    .then(() => {
                        currentUserId = null;
                        document.getElementById('crudSection').classList.add('d-none');
                        showAlert("success", "登出成功！");
                    })
                    .catch((error) => {
                        showAlert("error", "登出失敗", error.message);
                    });
            });

            // 保存筆記
            document.getElementById('noteForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const noteTitle = document.getElementById('noteTitle').value.trim();
                const noteContent = document.getElementById('noteContent').value.trim();
                const editingNoteId = document.getElementById('editingNoteId').value;

                if (noteTitle && noteContent) {
                    if (editingNoteId) {
                        updateNote(editingNoteId, { title: noteTitle, content: noteContent });
                    } else {
                        addNewNote({ title: noteTitle, content: noteContent });
                    }
                } else {
                    showAlert("error", "請完整填寫表單！");
                }
            });

            // 加載筆記
            function loadNotes() {
                database.ref(`notes/${currentUserId}`).once('value')
                    .then((snapshot) => {
                        const notesList = document.querySelector('#notesList .list-group');
                        notesList.innerHTML = '';
                        if (snapshot.exists()) {
                            const notes = snapshot.val();
                            Object.keys(notes).forEach(noteId => {
                                const note = notes[noteId];
                                const noteItem = document.createElement('div');
                                noteItem.className = 'list-group-item';
                                noteItem.innerHTML = `
                                    <h5>${note.title}</h5>
                                    <p>${note.content}</p>
                                    <div class="d-flex justify-content-end">
                                        <button class="btn btn-warning btn-sm me-2" onclick="editNote('${noteId}')">修改</button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteNote('${noteId}')">刪除</button>
                                    </div>
                                `;
                                notesList.appendChild(noteItem);
                            });
                        } else {
                            notesList.innerHTML = '<p class="text-muted">尚無筆記</p>';
                        }
                    })
                    .catch(error => {
                        console.error('無法加載筆記：', error);
                    });
            }

            // 新增筆記
            function addNewNote(note) {
                const newNoteId = database.ref(`notes/${currentUserId}`).push().key;
                database.ref(`notes/${currentUserId}/${newNoteId}`).set({
                    ...note,
                    timestamp: new Date().toISOString()
                })
                    .then(() => {
                        showAlert("success", "筆記新增成功！");
                        document.getElementById('noteForm').reset();
                        loadNotes();
                    })
                    .catch(error => {
                        console.error('無法新增筆記：', error);
                    });
            }

            // 修改筆記
            function updateNote(noteId, note) {
                database.ref(`notes/${currentUserId}/${noteId}`).update(note)
                    .then(() => {
                        showAlert("success", "筆記修改成功！");
                        document.getElementById('noteForm').reset();
                        document.getElementById('editingNoteId').value = '';
                        loadNotes();
                    })
                    .catch(error => {
                        console.error('無法修改筆記：', error);
                    });
            }

            // 編輯筆記
            window.editNote = function (noteId) {
                database.ref(`notes/${currentUserId}/${noteId}`).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const note = snapshot.val();
                            document.getElementById('noteTitle').value = note.title;
                            document.getElementById('noteContent').value = note.content;
                            document.getElementById('editingNoteId').value = noteId;
                        } else {
                            showAlert("error", "筆記不存在！");
                        }
                    })
                    .catch(error => {
                        console.error('無法讀取筆記：', error);
                    });
            };

            // 刪除筆記
            window.deleteNote = function (noteId) {
                database.ref(`notes/${currentUserId}/${noteId}`).remove()
                    .then(() => {
                        showAlert("success", "筆記刪除成功！");
                        loadNotes();
                    })
                    .catch(error => {
                        console.error('無法刪除筆記：', error);
                    });
            };

            // 警告提示
            function showAlert(type, message) {
                Swal.fire({ icon: type, title: message, timer: 3000, showConfirmButton: false });
            }
        });
    </script>
</body>

</html>
